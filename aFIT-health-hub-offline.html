<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>aFIT — A Health Hub (Offline Prototype)</title>
  <style>
    :root { --bg:#f8fafc; --fg:#0f172a; --muted:#64748b; --card:#ffffff; --green:#16a34a; --red:#dc2626; --border:#e2e8f0;}
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--fg); }
    header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; }
    .container { max-width: 1100px; margin: 0 auto; padding: 0 20px 32px; }
    h1 { font-size: 22px; margin:0; }
    .row { display:flex; flex-wrap: wrap; gap:12px; align-items:center; }
    .btn { background:#0ea5e9; color:#fff; border:none; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.outline { background:#fff; color:#0ea5e9; border:1px solid #0ea5e9; }
    .hint { color: var(--muted); font-size: 12px; }
    .card { background: var(--card); border:1px solid var(--border); border-radius:16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .card .hd { padding:16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .card .bd { padding:16px; }
    .grid { display:grid; gap:12px; }
    @media(min-width: 768px){ .grid.cols-3{ grid-template-columns: repeat(3,1fr);} .grid.cols-4{ grid-template-columns: repeat(4,1fr);} .grid.cols-2{ grid-template-columns: repeat(2,1fr);} .grid.cols-6{ grid-template-columns: repeat(6,1fr);} }
    .metric { border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff; min-height:76px; }
    .metric .t { font-size:12px; color:var(--muted); display:flex; justify-content:space-between; }
    .metric .v { font-size:18px; font-weight:700; margin-top:4px; }
    .delta { font-size:12px; font-weight:700; }
    .delta.up { color: var(--green); }
    .delta.down { color: var(--red); }
    .footer { color: var(--muted); font-size: 12px; padding: 12px 0; }
    select, .input { border:1px solid var(--border); border-radius:10px; padding:8px 10px; background:#fff; }
    .alert { display:flex; align-items:center; gap:8px; font-size:14px; padding:8px 10px; border-radius:10px; border:1px solid var(--border); }
    .ok { color: var(--green); }
    .no { color: var(--red); }
    .nowrap { white-space: nowrap; }
    .sr { position:absolute; left:-9999px; }
    .skeleton { background: linear-gradient(90deg,#f2f4f8 25%,#e6e9ef 37%,#f2f4f8 63%); background-size:400% 100%; animation: shimmer 1.2s infinite; border-radius:8px; height: 18px; display:inline-block; width:60px; }
    @keyframes shimmer { 0%{background-position: 100% 0} 100%{background-position: 0 0} }
    svg.spark { width:100%; height:120px; background:transparent; }
    .emptyChart { height:120px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:12px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>aFIT — A Health Hub</h1>
      <div class="row">
        <button id="btnSample" class="btn">Load Sample Data</button>
        <label class="btn outline">
          Import CSV
          <input id="fileInput" class="sr" type="file" accept=".csv"/>
        </label>
      </div>
    </header>

    <!-- Today Card -->
    <div class="card" style="margin-top:8px;">
      <div class="hd">
        <div>
          <div style="font-weight:700">Today</div>
          <div id="today-date" class="hint">— • Deltas vs 7‑day avg</div>
        </div>
        <div id="today-nba" class="hint nowrap">Load data to see a recommendation.</div>
      </div>
      <div class="bd">
        <div id="metrics-grid" class="grid cols-4">
          <!-- metrics tiles go here -->
        </div>
      </div>
    </div>

    <!-- Trend charts -->
    <div id="charts" class="grid cols-3" style="margin-top:12px;">
      <!-- charts inserted here -->
    </div>

    <!-- Insight Builder -->
    <div class="card" style="margin-top:12px;">
      <div class="hd"><div style="font-weight:700">Insight Builder</div></div>
      <div class="bd">
        <div class="row" style="margin-bottom:8px;">
          <label> X&nbsp;
            <select id="selX"></select>
          </label>
          <label> Y&nbsp;
            <select id="selY"></select>
          </label>
          <div class="hint">Pearson r: <b id="pearson">n/a</b></div>
        </div>
        <div id="corr-text" class="hint">Load sample data or import a CSV to compute relationships.</div>
      </div>
    </div>

    <!-- Goals & Alerts -->
    <div class="card" style="margin-top:12px;">
      <div class="hd"><div style="font-weight:700">Goals & Alerts (last 7 days)</div></div>
      <div id="alerts" class="bd grid cols-3">
        <!-- alerts go here -->
      </div>
    </div>

    <div class="footer">Fully offline. Use “Load Sample Data” or import CSV with columns: <code>date, steps, hrv, rhr, sleep_hours, sleep_quality, weight, body_fat, calories</code>.</div>
  </div>

  <script>
    const METRICS = [
      { key: "steps", label: "Steps" },
      { key: "hrv", label: "HRV (ms)", unit: "ms" },
      { key: "rhr", label: "Resting HR", unit: "bpm" },
      { key: "sleep_hours", label: "Sleep (h)", unit: "h" },
      { key: "sleep_quality", label: "Sleep Quality (%)", unit: "%" },
      { key: "weight", label: "Weight (lb)", unit: "lb" },
      { key: "body_fat", label: "Body Fat (%)", unit: "%" },
      { key: "calories", label: "Calories" },
    ];
    const GOOD_WHEN_HIGH = new Set(["steps","hrv","sleep_hours","sleep_quality"]);
    const GOOD_WHEN_LOW  = new Set(["rhr","weight","body_fat","calories"]);

    function parseNumber(x){
      if (x === null || x === undefined || x === "") return undefined;
      const n = Number(String(x).replace(/[^0-9.\-]/g, ""));
      return isFinite(n) ? n : undefined;
    }

    function fmt(v, unit){
      if (v === undefined) return "—";
      if (unit === "%") return v.toFixed(1) + " %";
      if (unit === "h") return v.toFixed(1) + " h";
      if (unit === "lb") return v.toFixed(1) + " lb";
      if (unit === "ms") return v.toFixed(0) + " ms";
      if (unit === "bpm") return v.toFixed(0) + " bpm";
      return String(v.toFixed(0));
    }

    function generateEmpty(days=28){
      const start = new Date(); start.setDate(start.getDate() - (days-1));
      const arr = [];
      for(let i=0;i<days;i++){ const d = new Date(start); d.setDate(start.getDate()+i); arr.push({date:d.toISOString().slice(0,10)}); }
      return arr;
    }

    function generateSample(days=28){
      const start = new Date(); start.setDate(start.getDate() - (days-1));
      const arr = []; let weight = 245, bf = 19.2, rhr = 57, hrv = 58;
      for(let i=0;i<days;i++){
        const d=new Date(start); d.setDate(start.getDate()+i);
        const weekday = d.getDay();
        const steps = Math.round(6000 + 3000*Math.sin(i/3) + (weekday>=1 && weekday<=5 ? 2000 : -500) + Math.random()*800);
        const calories = Math.round(2700 + (steps-8000)*0.05 + (Math.random()-0.5)*200);
        const sleep_hours = Number((7.2 + (Math.random()-0.5)*1.2 + (weekday===0?0.5:0)).toFixed(1));
        const sleep_quality = Math.max(50, Math.min(100, Math.round(80 + (Math.random()-0.5)*20 + (sleep_hours>7?5:-5))));
        rhr = Math.max(50, Math.min(65, rhr + (Math.random()-0.5)*1.2 + (sleep_hours<6.5 ? 0.6 : 0)));
        hrv = Math.max(40, Math.min(85, hrv + (Math.random()-0.5)*2 - (rhr>60 ? 0.8 : 0)));
        const surplus = calories - 2900;
        weight = Number((weight + surplus/7000 + (Math.random()-0.5)*0.15).toFixed(1));
        bf = Number((bf + surplus/20000 + (Math.random()-0.5)*0.03).toFixed(1));
        arr.push({date:d.toISOString().slice(0,10), steps, hrv:Math.round(hrv), rhr:Math.round(rhr), sleep_hours, sleep_quality, weight, body_fat:bf, calories});
      }
      return arr;
    }

    function rollingAvg(arr, window=7){
      const out=[];
      for(let i=0;i<arr.length;i++){
        const start = Math.max(0, i-window+1);
        const slice = arr.slice(start, i+1).filter(v => typeof v === "number");
        out.push(slice.length ? slice.reduce((a,b)=>a+b,0)/slice.length : undefined);
      }
      return out;
    }

    function pearson(xs, ys){
      const n = Math.min(xs.length, ys.length);
      if(n < 3) return NaN;
      const mx = xs.reduce((a,b)=>a+b,0)/n;
      const my = ys.reduce((a,b)=>a+b,0)/n;
      let num=0, dx=0, dy=0;
      for(let i=0;i<n;i++){ const vx=xs[i]-mx; const vy=ys[i]-my; num+=vx*vy; dx+=vx*vx; dy+=vy*vy; }
      return num/Math.sqrt(dx*dy);
    }

    // state
    let data = generateEmpty(28);

    // init UI template
    const metricsGrid = document.getElementById("metrics-grid");
    const charts = document.getElementById("charts");
    const selX = document.getElementById("selX");
    const selY = document.getElementById("selY");
    METRICS.forEach(m => {
      // metrics tiles
      const div = document.createElement("div");
      div.className = "metric";
      div.innerHTML = `<div class="t"><span>${m.label}</span><span class="delta">—</span></div>
                       <div class="v"><span class="skeleton"></span></div>
                       <div class="hint">7‑day avg: —</div>`;
      metricsGrid.appendChild(div);
      m._tile = div; // store ref

      // charts
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `<div class="hd"><div style="font-weight:600">${m.label}</div></div>`;
      const bd = document.createElement("div");
      bd.className = "bd";
      bd.style.height = "160px";
      bd.innerHTML = `<div class="emptyChart">No data yet</div>`;
      card.appendChild(bd);
      charts.appendChild(card);
      m._chartBody = bd; // store ref

      // insight selects
      const optX = document.createElement("option"); optX.value = m.key; optX.textContent = m.label; selX.appendChild(optX);
      const optY = document.createElement("option"); optY.value = m.key; optY.textContent = m.label; selY.appendChild(optY);
    });
    selX.value = "calories"; selY.value = "weight";

    function computeBaselines() {
      const avgs = {};
      METRICS.forEach(m => {
        avgs[m.key] = rollingAvg(data.map(d => d[m.key]));
      });
      return avgs;
    }

    function render(){
      const today = data[data.length -1];
      document.getElementById("today-date").textContent = (today?.date || "—") + " • Deltas vs 7‑day avg";
      const avgs = computeBaselines();
      const baselineIdx = Math.max(0, data.length - 2);

      // Today tiles
      METRICS.forEach((m, idx) => {
        const tile = m._tile;
        const val = today ? today[m.key] : undefined;
        const base = avgs[m.key][baselineIdx];
        const deltaVal = (typeof val === "number" && typeof base === "number") ? (val - base) : undefined;
        const deltaEl = tile.querySelector(".delta");
        const vEl = tile.querySelector(".v");
        const hintEl = tile.querySelector(".hint");
        if (deltaVal === undefined) {
          deltaEl.textContent = "—";
          deltaEl.className = "delta";
          vEl.innerHTML = `<span class="skeleton"></span>`;
          hintEl.textContent = "7‑day avg: —";
        } else {
          const good = GOOD_WHEN_HIGH.has(m.key) ? (deltaVal >= 0) : GOOD_WHEN_LOW.has(m.key) ? (deltaVal <= 0) : true;
          deltaEl.textContent = (deltaVal>0?"+":"") + deltaVal.toFixed(m.unit==="h"||m.unit==="%"||m.unit==="lb"?1:1);
          deltaEl.className = "delta " + (good ? "up" : "down");
          vEl.textContent = fmt(val, m.unit);
          hintEl.textContent = "7‑day avg: " + fmt(base, m.unit);
        }
      });

      // NBA
      const nba = [];
      if (today){
        const base = {};
        METRICS.forEach(m => base[m.key]=avgs[m.key][baselineIdx]);
        if (today.calories && base.calories && today.calories > base.calories + 150) nba.push("Trim ~150–250 kcal today.");
        if (today.steps && base.steps && today.steps < base.steps - 1000) nba.push("Add ~1k–2k steps.");
        if (today.sleep_hours && today.sleep_hours < 7) nba.push("Target ≥7 h sleep.");
        if (today.sleep_quality && today.sleep_quality < 75) nba.push("Improve sleep quality: earlier wind-down.");
      }
      document.getElementById("today-nba").textContent = nba[0] || "Stay the course. Small, steady wins.";

      // Charts
      const hasNumbers = data.some(d => METRICS.some(m => typeof d[m.key] === "number"));
      METRICS.forEach(m => {
        const bd = m._chartBody;
        bd.innerHTML = "";
        if (!hasNumbers){
          const div = document.createElement("div");
          div.className = "emptyChart"; div.textContent = "No data yet";
          bd.appendChild(div);
          return;
        }
        const w = bd.clientWidth || 300, h = 120, pad = 8;
        const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
        svg.setAttribute("class","spark");
        svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
        const points = data.map(d => d[m.key]).map(v => (typeof v === "number" ? v : null));
        const vals = points.filter(v => v !== null);
        const min = Math.min(...vals), max = Math.max(...vals);
        const range = (max - min) || 1;
        const toX = (i) => pad + i*( (w-2*pad) / Math.max(1,(data.length-1)) );
        const toY = (v) => h - pad - ((v - min)/range)*(h-2*pad);
        let dAttr = "";
        points.forEach((v,i) => {
          if (v===null) return;
          const x = toX(i), y = toY(v);
          dAttr += (dAttr==="" ? `M ${x} ${y}` : ` L ${x} ${y}`);
        });
        const path = document.createElementNS("http://www.w3.org/2000/svg","path");
        path.setAttribute("d", dAttr);
        path.setAttribute("fill","none");
        path.setAttribute("stroke","#0ea5e9");
        path.setAttribute("stroke-width","2");
        svg.appendChild(path);
        bd.appendChild(svg);
      });

      // Insight
      const xKey = selX.value, yKey = selY.value;
      const xs = data.map(d => d[xKey]).filter(v => typeof v === "number");
      const ys = data.map(d => d[yKey]).filter(v => typeof v === "number");
      let r = NaN;
      if (xs.length >=3 && ys.length >=3){
        const n = Math.min(xs.length, ys.length);
        const x = xs.slice(-n), y = ys.slice(-n);
        r = pearson(x, y);
      }
      const pearsonEl = document.getElementById("pearson");
      pearsonEl.textContent = isNaN(r) ? "n/a" : r.toFixed(2);
      const corrText = document.getElementById("corr-text");
      if (isNaN(r)) corrText.textContent = "Load sample data or import a CSV to compute relationships.";
      else if (Math.abs(r) < 0.2) corrText.textContent = "Little to no linear relationship.";
      else if (Math.abs(r) < 0.4) corrText.textContent = "Weak relationship; interpret cautiously.";
      else if (Math.abs(r) < 0.7) corrText.textContent = r > 0 ? "Moderate positive: as X rises, Y tends to rise." : "Moderate negative: as X rises, Y tends to fall.";
      else corrText.textContent = r > 0 ? "Strong positive: X and Y move together." : "Strong negative: X up, Y down.";

      // Alerts
      const alerts = document.getElementById("alerts"); alerts.innerHTML = "";
      const last7 = data.slice(-7);
      function avg(k){ const vals = last7.map(d => d[k]).filter(v => typeof v === "number"); return vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : undefined; }
      const ruleList = [
        { label: "Weekly calorie avg ≤ 2900", pass: (avg("calories") ?? 0) <= 2900 },
        { label: "Sleep avg ≥ 7.0 h", pass: (avg("sleep_hours") ?? 0) >= 7.0 },
        { label: "Sleep quality avg ≥ 75%", pass: (avg("sleep_quality") ?? 0) >= 75 },
      ];
      ruleList.forEach(r => {
        const div = document.createElement("div");
        div.className = "alert " + (r.pass ? "ok" : "no");
        div.innerHTML = `<span aria-hidden="true">${r.pass ? "✔" : "⚠"}</span><span>${r.label}</span>`;
        alerts.appendChild(div);
      });
    }

    // initial render (template-only)
    render();

    // events
    document.getElementById("btnSample").addEventListener("click", () => {
      data = generateSample(28);
      render();
    });

    document.getElementById("fileInput").addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const text = String(reader.result || "");
        const rows = parseCSV(text);
        const byDate = {}; data.forEach(d => byDate[d.date] = { ...d });
        rows.forEach(r => { if (r.date) byDate[r.date] = { ...byDate[r.date], ...r }; });
        data = Object.values(byDate).sort((a,b)=> a.date.localeCompare(b.date));
        render();
        e.target.value = "";
      };
      reader.readAsText(file);
    });

    function parseCSV(text){
      // very basic CSV parser for comma-separated, handles simple quoted fields
      const lines = text.split(/\r?\n/).filter(l => l.trim().length);
      if (!lines.length) return [];
      const header = splitCSV(lines[0]).map(h => h.trim().toLowerCase());
      const out = [];
      for (let i=1;i<lines.length;i++){
        const cols = splitCSV(lines[i]);
        const rec = {};
        header.forEach((h, idx) => {
          const val = cols[idx] !== undefined ? cols[idx] : "";
          if (h === "date") rec.date = String(val).slice(0,10);
          else if (["steps","hrv","rhr","sleep_hours","sleep_quality","weight","body_fat","calories"].includes(h)) rec[h] = parseNumber(val);
        });
        if (rec.date) out.push(rec);
      }
      return out;
    }

    function splitCSV(line){
      const out = []; let cur = ""; let inQ = false;
      for (let i=0;i<line.length;i++){
        const ch = line[i];
        if (ch === '"'){ if (inQ && line[i+1] === '"'){ cur += '"'; i++; } else { inQ = !inQ; } }
        else if (ch === "," && !inQ){ out.push(cur); cur=""; }
        else { cur += ch; }
      }
      out.push(cur);
      return out;
    }
  </script>
</body>
</html>
