<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>aFIT — A Health Hub (Project 3 Prototype)</title>
  <style>
    :root { --bg:#f8fafc; --fg:#0f172a; --muted:#64748b; --card:#ffffff; --green:#16a34a; --red:#dc2626; --border:#e2e8f0;}
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--fg); }
    header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; }
    .container { max-width: 1100px; margin: 0 auto; padding: 0 20px 32px; }
    h1 { font-size: 22px; margin:0; }
    .row { display:flex; flex-wrap: wrap; gap:12px; align-items:center; }
    .btn { background:#0ea5e9; color:#fff; border:none; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.outline { background:#fff; color:#0ea5e9; border:1px solid #0ea5e9; }
    .hint { color: var(--muted); font-size: 12px; }
    .card { background: var(--card); border:1px solid var(--border); border-radius:16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .card .hd { padding:16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .card .bd { padding:16px; }
    .grid { display:grid; gap:12px; }
    @media(min-width: 768px){ .grid.cols-3{ grid-template-columns: repeat(3,1fr);} .grid.cols-4{ grid-template-columns: repeat(4,1fr);} .grid.cols-2{ grid-template-columns: repeat(2,1fr);} .grid.cols-6{ grid-template-columns: repeat(6,1fr);} }
    .metric { border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff; min-height:76px; }
    .metric .t { font-size:12px; color:var(--muted); display:flex; justify-content:space-between; }
    .metric .v { font-size:18px; font-weight:700; margin-top:4px; }
    .delta { font-size:12px; font-weight:700; }
    .delta.up { color: var(--green); }
    .delta.down { color: var(--red); }
    .footer { color: var(--muted); font-size: 12px; padding: 12px 0; }
    select, .input { border:1px solid var(--border); border-radius:10px; padding:8px 10px; background:#fff; }
    .alert { display:flex; align-items:center; gap:8px; font-size:14px; padding:8px 10px; border-radius:10px; border:1px solid var(--border); }
    .ok { color: var(--green); }
    .no { color: var(--red); }
    .nowrap { white-space: nowrap; }
    .sr { position:absolute; left:-9999px; }
    .skeleton { background: linear-gradient(90deg,#f2f4f8 25%,#e6e9ef 37%,#f2f4f8 63%); background-size:400% 100%; animation: shimmer 1.2s infinite; border-radius:8px; height: 18px; }
    @keyframes shimmer { 0%{background-position: 100% 0} 100%{background-position: 0 0} }
  </style>
  <!-- React + ReactDOM + Babel (for JSX in-browser) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
  <!-- Recharts -->
  <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  <!-- PapaParse for CSV -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div id="root" class="container"></div>

  <script type="text/babel">
    const { useState, useMemo, useRef } = React;
    const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = Recharts;

    const METRICS = [
      { key: "steps", label: "Steps" },
      { key: "hrv", label: "HRV (ms)", unit: "ms" },
      { key: "rhr", label: "Resting HR", unit: "bpm" },
      { key: "sleep_hours", label: "Sleep (h)", unit: "h" },
      { key: "sleep_quality", label: "Sleep Quality (%)", unit: "%" },
      { key: "weight", label: "Weight (lb)", unit: "lb" },
      { key: "body_fat", label: "Body Fat (%)", unit: "%" },
      { key: "calories", label: "Calories" },
    ];

    function parseNumber(x) {
      if (x === null || x === undefined || x === "") return undefined;
      const n = Number(String(x).replace(/[^0-9.\\-]/g, ""));
      return isFinite(n) ? n : undefined;
    }

    function generateEmpty(days=28){
      const start = new Date(); start.setDate(start.getDate() - (days-1));
      const arr = [];
      for(let i=0;i<days;i++){
        const d = new Date(start); d.setDate(start.getDate() + i);
        arr.push({ date: d.toISOString().slice(0,10) });
      }
      return arr;
    }

    function generateSampleData(days=28){
      const start = new Date(); start.setDate(start.getDate() - (days-1));
      const arr = [];
      let weight = 245, bf = 19.2, rhr = 57, hrv = 58;
      for (let i = 0; i < days; i++) {
        const d = new Date(start); d.setDate(start.getDate() + i);
        const weekday = d.getDay();
        const steps = Math.round(6000 + 3000 * Math.sin(i / 3) + (weekday >= 1 && weekday <= 5 ? 2000 : -500) + Math.random() * 800);
        const calories = Math.round(2700 + (steps - 8000) * 0.05 + (Math.random() - 0.5) * 200);
        const sleep_hours = Number((7.2 + (Math.random() - 0.5) * 1.2 + (weekday === 0 ? 0.5 : 0)).toFixed(1));
        const sleep_quality = Math.max(50, Math.min(100, Math.round(80 + (Math.random() - 0.5) * 20 + (sleep_hours > 7 ? 5 : -5))));
        rhr = Math.max(50, Math.min(65, rhr + (Math.random() - 0.5) * 1.2 + (sleep_hours < 6.5 ? 0.6 : 0)));
        hrv = Math.max(40, Math.min(85, hrv + (Math.random() - 0.5) * 2 - (rhr > 60 ? 0.8 : 0)));
        const surplus = calories - 2900;
        weight = Number((weight + surplus / 7000 + (Math.random() - 0.5) * 0.15).toFixed(1));
        bf = Number((bf + surplus / 20000 + (Math.random() - 0.5) * 0.03).toFixed(1));
        arr.push({ date: d.toISOString().slice(0,10), steps, hrv: Math.round(hrv), rhr: Math.round(rhr), sleep_hours, sleep_quality, weight, body_fat: bf, calories });
      }
      return arr;
    }

    function rollingAvg(data, window=7){
      const out = [];
      for(let i=0;i<data.length;i++){
        const start = Math.max(0, i - window + 1);
        const slice = data.slice(start, i+1).filter(x => typeof x === "number");
        out.push(slice.length ? slice.reduce((a,b)=>a+b,0)/slice.length : undefined);
      }
      return out;
    }

    function pearson(xs, ys){
      const n = Math.min(xs.length, ys.length);
      if(n < 3) return NaN;
      const mx = xs.reduce((a,b)=>a+b,0)/n;
      const my = ys.reduce((a,b)=>a+b,0)/n;
      let num=0, dx=0, dy=0;
      for(let i=0;i<n;i++){ const vx = xs[i]-mx; const vy = ys[i]-my; num += vx*vy; dx += vx*vx; dy += vy*vy; }
      return num/Math.sqrt(dx*dy);
    }

    function fmt(v, unit){
      if (v === undefined) return "—";
      if (unit === "%") return v.toFixed(1) + " %";
      if (unit === "h") return v.toFixed(1) + " h";
      if (unit === "lb") return v.toFixed(1) + " lb";
      if (unit === "ms") return v.toFixed(0) + " ms";
      if (unit === "bpm") return v.toFixed(0) + " bpm";
      return String(v.toFixed(0));
    }

    function App(){
      const [data, setData] = useState(generateEmpty(28)); // start EMPTY (template visible)
      const fileRef = useRef(null);

      const today = data[data.length - 1];
      const avgs = useMemo(() => {
        const obj = {}; METRICS.forEach(m => obj[m.key] = rollingAvg(data.map(d => d[m.key]))); return obj;
      }, [data]);
      const baselineIdx = Math.max(0, data.length - 2);
      const baseline = useMemo(() => {
        const b = {}; METRICS.forEach(m => b[m.key] = avgs[m.key][baselineIdx]); return b;
      }, [avgs, baselineIdx]);

      function delta(a, b){
        if (a === undefined || b === undefined) return { val: 0, sign: 0 };
        const val = a - b; return { val, sign: val === 0 ? 0 : val > 0 ? 1 : -1 };
      }
      function colorForDelta(key, d){
        const goodWhenHigh = ["steps","hrv","sleep_hours","sleep_quality"];
        const goodWhenLow = ["rhr","weight","body_fat","calories"];
        if (goodWhenHigh.includes(key)) return d >= 0 ? "delta up" : "delta down";
        if (goodWhenLow.includes(key)) return d <= 0 ? "delta up" : "delta down";
        return "delta";
      }
      function nbAction(){
        if (!today) return "Load data to see a recommendation.";
        const msgs = [];
        if (today.calories && baseline.calories && today.calories > (baseline.calories||0) + 150) msgs.push("Trim ~150–250 kcal today.");
        if (today.steps && baseline.steps && today.steps < (baseline.steps||0) - 1000) msgs.push("Add ~1k–2k steps.");
        if (today.sleep_hours && today.sleep_hours < 7) msgs.push("Target ≥7 h sleep.");
        if (today.sleep_quality && today.sleep_quality < 75) msgs.push("Improve sleep quality: earlier wind-down, dark/cool room.");
        return msgs[0] || "Stay the course. Small, steady wins.";
      }

      // Insight Builder
      const [metricX, setMetricX] = useState("calories");
      const [metricY, setMetricY] = useState("weight");
      const corr = useMemo(() => {
        const xs = data.map(d => d[metricX]).filter(n => typeof n === "number");
        const ys = data.map(d => d[metricY]).filter(n => typeof n === "number");
        const r = pearson(xs, ys);
        return r;
      }, [data, metricX, metricY]);

      // Alerts over last 7 days
      const last7 = data.slice(-7);
      const wkAvg = (k) => {
        const vals = last7.map(d => d[k]).filter(n => typeof n === "number");
        return vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : undefined;
      };
      const rules = [
        { label: "Weekly calorie avg ≤ 2900", pass: (wkAvg("calories") ?? 0) <= 2900 },
        { label: "Sleep avg ≥ 7.0 h", pass: (wkAvg("sleep_hours") ?? 0) >= 7.0 },
        { label: "Sleep quality avg ≥ 75%", pass: (wkAvg("sleep_quality") ?? 0) >= 75 },
      ];

      function handleImportCSV(e){
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        Papa.parse(f, {
          header: true, dynamicTyping: true, skipEmptyLines: true,
          complete: (results) => {
            const rows = results.data.map(r => ({
              date: String(r.date || r.Date || r.DATE || "").slice(0, 10),
              steps: parseNumber(r.steps ?? r.Steps),
              hrv: parseNumber(r.hrv ?? r.HRV),
              rhr: parseNumber(r.rhr ?? r.RHR ?? r.rest_hr),
              sleep_hours: parseNumber(r.sleep_hours ?? r.sleep ?? r.SleepHours),
              sleep_quality: parseNumber(r.sleep_quality ?? r.SleepQuality),
              weight: parseNumber(r.weight ?? r.Weight),
              body_fat: parseNumber(r.body_fat ?? r.BodyFat),
              calories: parseNumber(r.calories ?? r.Calories),
            })).filter(r => r.date);
            const byDate = {}; data.forEach(d => byDate[d.date] = { ...d });
            rows.forEach(r => byDate[r.date] = { ...byDate[r.date], ...r });
            const merged = Object.values(byDate).sort((a,b)=>a.date.localeCompare(b.date));
            setData(merged);
            if(fileRef.current) fileRef.current.value = "";
          }
        });
      }

      const hasAnyNumbers = data.some(d => METRICS.some(m => typeof d[m.key] === "number"));

      return (
        <div>
          {/* Header inside React */}
          <header>
            <h1>aFIT — A Health Hub</h1>
            <div className="row">
              <button className="btn" onClick={()=>setData(generateSampleData(28))}>Load Sample Data</button>
              <label className="btn outline">
                Import CSV
                <input ref={fileRef} className="sr" type="file" accept=".csv" onChange={handleImportCSV}/>
              </label>
            </div>
          </header>

          {/* Today Card */}
          <div className="card" style={{marginTop: 8}}>
            <div className="hd">
              <div>
                <div style={{fontWeight:700}}>Today</div>
                <div className="hint">{today?.date || "—"} • Deltas vs 7‑day avg</div>
              </div>
              <div className="hint nowrap">{nbAction()}</div>
            </div>
            <div className="bd">
              <div className="grid cols-4">
                {METRICS.map(m => {
                  const val = today?.[m.key];
                  const base = baseline[m.key];
                  const d = delta(val, base);
                  const cls = colorForDelta(m.key, d.val);
                  return (
                    <div key={m.key} className="metric">
                      <div className="t">
                        <span>{m.label}</span>
                        <span className={cls}>{(typeof val === "number" && typeof base === "number") ? (d.val > 0 ? `+${d.val.toFixed(1)}` : d.val.toFixed(1)) : "—"}</span>
                      </div>
                      <div className="v">{typeof val === "number" ? fmt(val, m.unit) : <span className="skeleton" style={{display:"inline-block", width: 60}}></span>}</div>
                      <div className="hint">7‑day avg: {typeof base === "number" ? fmt(base, m.unit) : "—"}</div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>

          {/* Trend charts */}
          <div className="grid cols-3" style={{marginTop:12}}>
            {METRICS.map(m => (
              <div key={m.key} className="card">
                <div className="hd"><div style={{fontWeight:600}}>{m.label}</div></div>
                <div className="bd" style={{height:160}}>
                  {hasAnyNumbers ? (
                    <ResponsiveContainer width="100%" height="100%">
                      <LineChart data={data} margin={{left: -20, right: 10, top: 10, bottom: 0}}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="date" hide />
                        <YAxis hide domain={["auto","auto"]} />
                        <Tooltip formatter={(v) => (typeof v === "number" ? v.toFixed(2) : v)} labelFormatter={(l)=>`Date: ${l}`} />
                        <Line type="monotone" dataKey={m.key} dot={false} strokeWidth={2} />
                      </LineChart>
                    </ResponsiveContainer>
                  ) : (
                    <div className="skeleton" style={{height: 120}}></div>
                  )}
                </div>
              </div>
            ))}
          </div>

          {/* Insight Builder */}
          <div className="card" style={{marginTop:12}}>
            <div className="hd"><div style={{fontWeight:700}}>Insight Builder</div></div>
            <div className="bd">
              <div className="row" style={{marginBottom:8}}>
                <label> X&nbsp;
                  <select value={metricX} onChange={(e)=>setMetricX(e.target.value)}>
                    {METRICS.map(m => <option key={m.key} value={m.key}>{m.label}</option>)}
                  </select>
                </label>
                <label> Y&nbsp;
                  <select value={metricY} onChange={(e)=>setMetricY(e.target.value)}>
                    {METRICS.map(m => <option key={m.key} value={m.key}>{m.label}</option>)}
                  </select>
                </label>
                <div className="hint">Pearson r: <b>{isNaN(corr) ? "n/a" : corr.toFixed(2)}</b></div>
              </div>
              <div className="hint">
                {isNaN(corr) ? "Load sample data or import a CSV to compute relationships."
                : Math.abs(corr) < 0.2 ? "Little to no linear relationship."
                : Math.abs(corr) < 0.4 ? "Weak relationship; interpret cautiously."
                : Math.abs(corr) < 0.7 ? (corr > 0 ? "Moderate positive: as X rises, Y tends to rise." : "Moderate negative: as X rises, Y tends to fall.")
                : (corr > 0 ? "Strong positive: X and Y move together." : "Strong negative: X up, Y down.")}
              </div>
            </div>
          </div>

          {/* Goals & Alerts */}
          <div className="card" style={{marginTop:12}}>
            <div className="hd"><div style={{fontWeight:700}}>Goals & Alerts (last 7 days)</div></div>
            <div className="bd grid cols-3">
              {rules.map((r,i)=>(
                <div key={i} className={"alert " + (r.pass ? "ok" : "no")}>
                  <span aria-hidden="true">{r.pass ? "✔" : "⚠"}</span>
                  <span>{r.label}</span>
                </div>
              ))}
            </div>
          </div>

          <div className="footer">Runs locally in your browser. Use “Load Sample Data” to populate the template or import a CSV with columns: <code>date, steps, hrv, rhr, sleep_hours, sleep_quality, weight, body_fat, calories</code>.</div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App/>);
  </script>
</body>
</html>
